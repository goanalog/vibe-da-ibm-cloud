<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vibe IDE ‚Äî Max Vibe Edition</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f14; --card:#121823; --muted:#9aa6b2; --txt:#e6f1ff; --neon:#7afcff; --neon2:#ffa6ff; --neon3:#9dffad
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--txt); font:16px/1.6 "IBM Plex Sans",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background:
        radial-gradient(1200px 800px at 15% 0%, rgba(122,252,255,.08), transparent 60%),
        radial-gradient(900px 600px at 120% 10%, rgba(255,166,255,.08), transparent 60%),
        radial-gradient(900px 700px at 80% 120%, rgba(157,255,173,.08), transparent 60%),
        var(--bg);
      display:grid; place-items:center; padding:24px;
      cursor: crosshair;
    }
    .card{
      width:min(940px, 94vw);
      background:
        linear-gradient(180deg, rgba(122,252,255,.06), rgba(255,166,255,.06)) padding-box,
        linear-gradient(180deg, rgba(122,252,255,.35), rgba(255,166,255,.35)) border-box;
      border:1px solid transparent; border-radius:20px; padding:28px;
      box-shadow:0 24px 80px rgba(0,0,0,.45), 0 0 60px rgba(122,252,255,.08) inset;
    }
    h1{margin:0 0 6px; font-size:clamp(28px,4vw,44px); letter-spacing:.3px}
    p{margin:0 0 18px; color:var(--muted)}
    .row{display:flex; gap:14px; flex-wrap:wrap; margin-top:18px; align-items: center;} /* Added align-items */
    .btn{
      border:1px solid rgba(122,252,255,.35);
      padding:12px 16px; border-radius:12px; cursor:pointer; background:#0e141d;
      color:var(--txt);
      text-decoration:none; display:inline-flex; align-items:center; gap:10px;
      transition: transform .08s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .btn:hover{transform:translateY(-1px); border-color:var(--neon)}
    .btn:disabled { cursor: not-allowed; opacity: 0.6; } /* Style for disabled button */
    code{background:#0d1420;border:1px solid rgba(122,252,255,.15);padding:2px 6px;border-radius:8px;font-family:"IBM Plex Mono",monospace}
    footer{margin-top:18px; font-size:12px; color:#7d8a97}
    .kbd{font-family:"IBM Plex Mono",monospace; font-size:12px; padding:1px 6px; border-radius:6px; background:#0d1420;
      border:1px solid rgba(122,252,255,.15)}
    .row label { display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--muted); font-size: 14px; }
    .row input[type="checkbox"] { accent-color: var(--neon); }
  </style>
</head>
<body>
  <main class="card">
    <h1>Vibe is live ‚ú®</h1>
    <p>Deployed on IBM Cloud Object Storage as a static website. Use the buttons below to trigger IBM Cloud Code Engine functions.</p>

    <div class="row">
      <button class="btn" id="pushCos">Push to COS</button> <button class="btn" id="pushProject">Push to Project</button> <label>
         <input type="checkbox" id="autoDeployToggle"> Trigger Deploy After Push?
       </label>
    </div>
     <div class="row">
       <a class="btn" href="https://www.ibm.com/architectures/deployable-architectures" target="_blank">Deployable Architectures</a>
       <a class="btn" href="https://www.ibm.com/products/bob" target="_blank">IBM Project Bob</a>
     </div>

    <footer>
      Edit this page in <code>index.html</code>.
      Tip: press <span class="kbd">R</span> to ‚Äúremix‚Äù the vibe gradient.
    </footer>
  </main>

  <script>
    // These get templated by Terraform
    const PUSH_COS_URL       = "${push_cos_url}";
    const PUSH_PROJECT_URL   = "${push_project_url}"; // Staging URL
    const TRIGGER_DEPLOY_URL = "${trigger_deploy_url}"; // Trigger URL

    const pushCosButton = document.getElementById("pushCos");
    const pushProjectButton = document.getElementById("pushProject");
    const autoDeployToggle = document.getElementById("autoDeployToggle");

    // General Fetch Function
    async function performFetch(url, buttonElement, buttonText) {
       if (!url || url === "null") {
          alert("Functionality is disabled or not configured in this deployment.");
          return { success: false, message: "URL not configured." };
       }

       buttonElement.textContent = 'Processing...';
       buttonElement.disabled = true;

       try {
          const response = await fetch(url, { method: "POST" });
          const text = await response.text(); // Always get text first
          console.log(`Response Status: ${response.status}, Body: ${text.substring(0, 200)}...`); // Log status and partial body

          if (!response.ok) { // Check status code range (200-299)
             throw new Error(`HTTP error ${response.status}: ${text}`);
          }
          // Consider 202 Accepted also a success for trigger
          if (response.status === 202 && buttonElement === pushProjectButton) {
             console.log("Deployment trigger likely accepted.");
          }
          return { success: true, message: text };
       } catch (error) {
          console.error("Fetch Error:", error);
          // Don't alert here, let the calling function handle combined messages
          return { success: false, message: error.message };
       } finally {
          // Check if the button still exists before modifying
          if (document.body.contains(buttonElement)) {
              buttonElement.textContent = buttonText;
              buttonElement.disabled = false;
          }
       }
    }

    // Push to COS Handler
    pushCosButton.onclick = async () => {
        const result = await performFetch(PUSH_COS_URL, pushCosButton, 'Push to COS');
        if (result.success) {
            alert("COS Push Response:\n" + result.message);
        } else {
            alert("COS Push Error:\n" + result.message); // Alert specific error
        }
    };

    // Push to Project Handler (Staging + Optional Trigger)
    pushProjectButton.onclick = async () => {
        let finalMessage = "";

        // Step 1: Always call the staging function
        const stageResult = await performFetch(PUSH_PROJECT_URL, pushProjectButton, 'Push to Project');

        if (stageResult.success) {
            finalMessage = "‚úÖ Staging Response:\n" + stageResult.message;

            // Step 2: Check toggle and call trigger function if needed
            if (autoDeployToggle.checked) {
                // Give user feedback before starting the second potentially long call
                alert("Staging successful. Now attempting to trigger deployment...");

                // Ensure button is re-enabled before the second call potentially disables it again
                pushProjectButton.textContent = 'Triggering Deploy...';
                pushProjectButton.disabled = true;

                const triggerResult = await performFetch(TRIGGER_DEPLOY_URL, pushProjectButton, 'Push to Project'); // Reset text correctly

                if (triggerResult.success) {
                    finalMessage += "\n\nüöÄ Deployment Trigger Response:\n" + triggerResult.message;
                } else {
                    finalMessage += "\n\n‚ö†Ô∏è Deployment Trigger Failed:\n" + triggerResult.message;
                }
            } else {
                 finalMessage += "\n\n(Auto-deploy disabled, changes are staged only)";
            }
             alert(finalMessage); // Show combined result only after everything
        } else {
             alert("‚ùå Staging Error:\n" + stageResult.message); // Alert specific staging error
             // Don't proceed to trigger if staging failed
        }
    };


    // Little vibe remix (no changes)
    addEventListener("keydown", (e)=>{
      if(e.key.toLowerCase()==="r"){
        document.body.style.backgroundPosition = `${Math.random()*100}% ${Math.random()*100}%`;
      }
    });
  </script>
</body>
</html>